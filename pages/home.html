<br/>

<!-- Statistics -->
<div id="poolStats" class="row">

    <!-- Pool Hash Rate -->
    <div class="col-lg-4 col-md-4 col-sm-5">
        <div class="infoBox hoverExpandEffect">
            <div class="icon">
                <span class="fa fa-heartbeat"></span>
            </div>
            <div class="content">
                <div class="text"><span tkey="poolHashrate">Pool Hash Rate</span></div>
                <div class="value"><span id="poolHashrate">N/A</span> <span class="smallText">(<span id="hashPower">0%</span>)</span></div>
            </div>
        </div>
    </div>
    
    <!-- Network Hash Rate -->
    <div class="col-lg-4 col-md-4 col-sm-5">
        <div class="infoBox hoverExpandEffect">
            <div class="icon">
                <span class="fa fa-sitemap"></span>
            </div>
            <div class="content">
                <div class="text"><span tkey="networkHashrate">Network Hash Rate</span></div>
                <div class="value"><span id="networkHashrate">N/A</span></div>
            </div>
        </div>
    </div>
    


    <!-- Difficulty -->
    <div class="col-lg-4 col-md-4 col-sm-5">
        <div class="infoBox hoverExpandEffect">
            <div class="icon">
                <span class="fa fa-unlock-alt"></span>
            </div>
            <div class="content">
                <div class="text"><span tkey="networkDifficulty">Difficulty</span></div>
                <div class="value"><span id="networkDifficulty">N/A</span></div>
            </div>
        </div>
    </div>

    <!-- Blocks Found -->
    <div class="col-lg-4 col-md-4 col-sm-5">
        <div class="infoBox hoverExpandEffect">
            <div class="icon">
                <span class="fa fa-cubes"></span>
            </div>
            <div class="content">
                <div class="text"><span tkey="blocksTotal">Blocks Found</span></div>
                <div class="value"><span id="blocksTotal">N/A</span> <span class="smallText">(<span id="poolLastBlockFound">Never</span>)</span></div>
            </div>
        </div>
    </div>
    
    <!-- Blocks Found Every -->
    <div class="col-lg-4 col-md-4 col-sm-5">
        <div class="infoBox hoverExpandEffect">
            <div class="icon">
                <span class="fa fa-history"></span>
            </div>
            <div class="content">
                <div class="text"><span tkey="blockSolvedTime">Blocks Found Every</span></div>
                <div class="value"><span id="blockSolvedTime">N/A</span> <span class="smallText">(<span tkey="estimated">estimated</span>)</span></div>
            </div>
        </div>
    </div>

    <!-- Current Effort -->
    <div class="col-lg-4 col-md-4 col-sm-5">
        <div class="infoBox hoverExpandEffect">
            <div class="icon">
                <span class="fa fa-chart-line"></span>
            </div>
            <div class="content">
                <div class="text"><span tkey="currentEffort">Current Effort</span></div>
                <div class="value"><span id="currentEffort">N/A</span></div>
            </div>
        </div>
    </div>
    
    
    

    
    <!-- Blockchain Height -->
    <div class="col-lg-4 col-md-4 col-sm-5">
        <div class="infoBox hoverExpandEffect">
            <div class="icon">
                <span class="fa fa-bars"></span>
            </div>
            <div class="content">
                <div class="text"><span tkey="blockchainHeight">Blockchain Height</span></div>
                <div class="value"><span id="blockchainHeight">N/A</span></div>
            </div>
        </div>
    </div>

    <!-- Last Reward -->
    <div class="col-lg-4 col-md-4 col-sm-5">
        <div class="infoBox hoverExpandEffect">
            <div class="icon">
                <span class="fa fa-hand-holding-usd"></span>
            </div>
            <div class="content">
                <div class="text"><span tkey="networkLastReward">Last Reward</span></div>
                <div class="value"><span id="networkLastReward">N/A</span>(<span id="poolLastReward">N/A</span>)</div>
            </div>
        </div>
    </div>


    <!-- Connected Miners -->
    <div class="col-lg-4 col-md-4 col-sm-5">
        <div class="infoBox hoverExpandEffect">
            <div class="icon">
                <span class="fa fa-users"></span>
            </div>
            <div class="content">
                <div class="text"><span tkey="poolMiners">Connected Miners</span></div>
                <div class="value"><span id="poolMiners">N/A</span> <span class="smallText">(<strong><span id="poolWorkers">N/A</span></strong> <span tkey="workersCount">workers</span>)</span></div>
            </div>
        </div>
    </div>


    <!-- Last Hash -->
    <div class="col-sm-12 col-md-6">
        <div class="hashInfo hoverExpandEffect">
            <div class="text"><span tkey="lastHash">Last Hash</span></div>
            <div class="content clearfix">
             <div class="value"><a id="lastHash" target="_blank">N/A</a></div>
             <div class="time">(<span id="networkLastBlockFound">Never</span>)</div>
         </div>
     </div>
 </div>

 <div class='col-sm-12 col-md-6'>
           <!-- Mining Profit Calculator -->
        <div id="miningProfitCalc">
            <div id="calcHashHolder">
                <div class="input-group">
                    <input class="form-control" id="calcHashRate" tplaceholder="enterYourHashrate" placeholder="Enter Your Hash Rate" type="number">
                    <div class="input-group-btn">
                        <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown" id="calcHashDropdown">
                            <span id="calcHashUnit" data-mul="1">KH/s</span> <span class="caret"></span>
                        </button>
                        <ul class="dropdown-menu dropdown-menu-right" role="menu" id="calcHashUnits">
                            <li><a href="#" data-mul="0">H/s</a></li>
                            <li><a href="#" data-mul="1">KH/s</a></li>
                            <li><a href="#" data-mul="2">MH/s</a></li>
                        </ul>
                    </div>
                    <span class="input-group-addon">=</span>            
                </div>
                <div id="calcHashResultsHolder">
                     <div id="calcHashAmount">
                        <span id="calcHashAmount1">0.00 XTL</span>
                    </div>
                    <div id="calcHashPeriod">
                        <span tkey="perDay">per day</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Pool Charts -->
<div class="row">
    <div class="hidden-xs col-md-2 col-sm-4 poolChart">
        <div class="card">
            <h4><span tkey="hashRate">Hash Rate</span></h4>
            <div class="chart">
                <canvas id="chart_hashrate"></canvas>
                <a class="chart-style"></a>
            </div> 
        </div>        
    </div>
    <div class="hidden-xs col-sm-4 col-md-2 poolChart">
        <div class="card">
            <h4><span tkey="difficulty">Difficulty</span></h4>
            <div class="chart">
                <canvas id="chart_diff"></canvas>
                <a class="chart-style"></a>
            </div> 
        </div>
    </div>
    <div class="hidden-xs col-md-2 col-sm-4 poolChart">
        <div class="card">
            <h4><span tkey="miners">Miners</span></h4>
            <div class="chart">
                <canvas id="chart_miners"></canvas>
                <a class="chart-style"></a>
            </div> 
        </div> 
    </div>    
    <div class="hidden-xs col-sm-4 col-md-2 poolChart">
        <div class="card">
            <h4><span tkey="workers">Workers</span></h4>
            <div class="chart">
                <canvas id="chart_workers"></canvas>
                <a class="chart-style"></a>
            </div> 
        </div> 
    </div>  
    <div class="hidden-xs col-sm-4 col-md-2 poolChart">
        <div class="card">
            <h4><span tkey="hashPer">Hash/</span>
                <span id="profitChartCurrency">USD</span> 
                <span data-toggle="tooltip" data-placement="top" data-original-title="Reward * Rate / Difficulty"><i class="fa fa-question-circle"></i></span>
            </h4>
            <div class="chart">
                <canvas id="chart_profit"></canvas>
                <a class="chart-style"></a>
            </div>
        </div>
    </div>
        <div class="hidden-xs col-sm-4 col-md-2 poolChart">
        <div class="card">
            <h4><span tkey="priceIn">Price in</span> <span id="priceChartCurrency">USD</span></h4>
            <div class="chart">
                <canvas id="chart_price"></canvas>
                <a class="chart-style"></a>
            </div>
        </div>        
    </div>
    <div class="hidden-xs col-sm-4 col-md-2 poolChart">
        <div class="card">
            <h4><span tkey="blockEfforts">Overall Efforts</span></h4>
            <div class="chart">
                <canvas id="chart_effort"></canvas>
                <a class="chart-style"></a>
            </div>
        </div>        
    </div>
    <div class="hidden-xs col-sm-6 col-md-6 poolChart">
        <div class="card">
            <h4><span tkey="blockEfforts">Props Efforts</span></h4>
            <div class="chart">
                <canvas id="chart_props_effort"></canvas>
                <a class="chart-style"></a>
            </div>
        </div>        
    </div>
    <div class="hidden-xs col-sm-6 col-md-6 poolChart">
        <div class="card">
            <h4><span tkey="blockEfforts">Solo Efforts</span></h4>
            <div class="chart">
                <canvas id="chart_solo_effort"></canvas>
                <a class="chart-style"></a>
            </div>
        </div>        
    </div>

    
</div>

<!-- Javascript -->
<script>
// Charts initialized
var chartsInitialized = false;
var intervalChartsUpdate;

// Update current page
currentPage = {
    destroy: function(){
        $('#networkLastBlockFound,#poolLastBlockFound').timeago('dispose');
        if (chartsInitialized) {
            chartsInitialized = false;
            clearInterval(intervalChartsUpdate);
        }
    },
    update: function(){
	//	updateText('poolDonations',getReadableCoins(lastStats.pool.totalDonations));    	

    $('#networkLastBlockFound').timeago('update', new Date(lastStats.lastblock.timestamp * 1000).toISOString());

    updateText('networkHashrate', getReadableHashRateString(lastStats.network.difficulty / lastStats.config.coinDifficultyTarget) + '/sec');
    updateText('networkDifficulty', formatNumber(lastStats.network.difficulty.toString(), ' '));
    updateText('blockchainHeight', formatNumber(lastStats.network.height.toString(), ' '));

    const poolLoad = parseFloat(lastStats.system.load[0] * 100 / lastStats.system.number_cores);

    updateText('poolLoad', (poolLoad).toFixed(2)+"%");

   updateText('lastHash', lastStats.lastblock.hash).setAttribute('href', getBlockchainUrl(lastStats.lastblock.hash));

   var reward = lastStats.pool.stats.lastblock_lastReward
   if (lastStats.config.networkFee) {
    var networkFeePercent = lastStats.config.networkFee / 100;
    updateText('networkLastReward', getReadableCoins(reward - (reward * networkFeePercent)));
} else {
    updateText('networkLastReward', getReadableCoins(reward));
}

reward = lastStats.pool.stats.lastblock_lastMinerReward || lastStats.pool.stats.lastblock_lastReward 
if (lastStats.config.networkFee) {
    var networkFeePercent = lastStats.config.networkFee / 100;
    updateText('poolLastReward', getReadableCoins(reward - (eward * networkFeePercent)));
} else {
    updateText('poolLastReward', getReadableCoins(reward));
}

updateText('poolHashrate', getReadableHashRateString(lastStats.pool.hashrate) + '/sec');
updateText('blocksTotal', lastStats.pool.stats.blocksFound.toString());

var hashPower = lastStats.pool.hashrate / (lastStats.network.difficulty / lastStats.config.coinDifficultyTarget) * 100;
updateText('hashPower', hashPower.toFixed(2) + '%');

if (lastStats.pool.stats.lastBlockFound) {
    var d = new Date(parseInt(lastStats.pool.stats.lastBlockFound)).toISOString();
    $('#poolLastBlockFound').timeago('update', d);
}
else {
    $('#poolLastBlockFound').removeAttr('title').data('ts', '').update('Never');
}

updateText('poolMiners', lastStats.pool.miners.toString());
updateText('poolWorkers', lastStats.pool.workers.toString());

var totalFee = 0;
updateText('paymentsInterval', getReadableTime(lastStats.config.paymentsInterval));
updateText('paymentsMinimum', getReadableCoins(lastStats.config.minPaymentThreshold));

updateText('blockSolvedTime', getReadableTime(lastStats.network.difficulty / lastStats.pool.hashrate));
updateText('currentEffort', (lastStats.pool.stats.roundShares / lastStats.network.difficulty * 100).toFixed(1) + '%');

if (lastStats.charts && !chartsInitialized) {
    intervalChartsUpdate = setInterval(createCharts, 60*1000);
    createCharts();
    chartsInitialized = true;
}

calcEstimateProfit();
}
};

// Enable timeago on last block found
$('#networkLastBlockFound,#poolLastBlockFound').timeago();

/**
 * Charts
 **/

// Create charts
function createCharts() {
    if (!lastStats || !lastStats.charts){
      return ;	
  }
  var data = lastStats.charts;
  var properties = [
  'height',
  'hash',
  'timestamp',
  'difficulty',
  'shares',
  'donations',
  'reward',
  'miner',
  'poolType',
  'orphaned',
  'unlocked'
  ]; 
  var blocks = [];
  var solo_effort = [];
  var props_effort = [];
  var difficulties = [];
  for(var i = 0;i<lastStats.pool.blocks.length;i++){
   var parts = lastStats.pool.blocks[i].split(':');
   var block = {};
   for(var a =0;a<properties.length;a++) {
    var property = properties[a];
        switch(property) {
           case 'unlocked':
           block[property] = (parts[a] === true || parts[a] === 'true');
           break;
           case 'orphaned':
           case 'height':
           case 'timestamp':
           case 'difficulty':
           case 'shares':
           case 'donations':
           case 'reward':
           case 'orphaned':
           block[property] = parseInt(parts[a])
           break;
           default:
           block[property] = parts[a]
           break;
       }
    }	
    var percent = Math.round(block.shares / block.difficulty * 100);
    var s = [];
    s.push(block.timestamp);
    s.push(percent);
    if(block.poolType === 'solo') {
        solo_effort.push(s);
    } else if(block.poolType === 'props') {
        props_effort.push(s);
    }
    blocks.push(s);
    difficulties.push([block.timestamp,block.difficulty]);
}
if(solo_effort.length === 0) {
    solo_effort.push([1612137600, 0]);
}
if(props_effort.length === 0) {
    props_effort.push([1612137600, 0]);
}
if(solo_effort.length === 1) {
    solo_effort.push(solo_effort[0]);
}
if(props_effort.length === 0) {
    props_effort.push(props_effort[0]);
}
var graphData = {
    hashrate: getGraphData(data.hashrate),
    diff: getGraphData(difficulties.reverse()),
    miners: getGraphData(data.miners),
    workers: getGraphData(data.workers),
    price: getGraphData(data.price),
    effort: getGraphData(blocks.reverse()),
    solo_effort: getGraphData(solo_effort.reverse()),
    props_effort: getGraphData(props_effort.reverse())
};

for (var graphType in graphData) {
    if (graphData[graphType].values.length > 1) {
        var $chart = $('#chart_'+graphType);
        var bgcolor = null, bordercolor = null, borderwidth = null;
        var colorelem = $chart.siblings('a.chart-style');
        if (colorelem.length == 1) {
            bgcolor = colorelem.css('background-color');
            bordercolor = colorelem.css('border-left-color');
            borderwidth = parseFloat(colorelem.css('width'));
        }
        if (bgcolor === null) bgcolor = 'rgba(3, 169, 244, .4)';
        if (bordercolor === null) bordercolor = '#03a9f4';
        if (borderwidth === null || isNaN(borderwidth)) borderwidth = 1;

        var chartObj = new Chart(document.getElementById('chart_'+graphType), {
            type: 'line',
            data: {
                labels: graphData[graphType].names,
                datasets: [{
                    data: graphData[graphType].values,
                    dataType: graphType,
                    fill: true,
                    backgroundColor: bgcolor,
                    borderColor: bordercolor,
                    borderWidth: borderwidth
                }]
            },
            options: {
                animation: false,
                responsive: true,
                maintainAspectRatio: false,
                legend: { display: false },
                elements: { point: { radius: 0, hitRadius: 10, hoverRadius: 5 } },
                scales: {
                    xAxes: [{
                        display: false,
                        ticks: { display: false },
                        gridLines: { display: false }
                    }],
                    yAxes: [{
                        display: false,
                        ticks: {
                            display: false,
                            beginAtZero: true,
                            userCallback: function(label, index, labels) {
                                if (Math.floor(label) === label) return label;
                            }
                        },
                        gridLines: { display: false }
                    }]
                },
                layout: {
                    padding: { top: 5, left: 10, right: 10, bottom: 10 }
                },
                tooltips: {
                    callbacks: {
                        label: function(tooltipItem, data) {
                            var dataType = data.datasets[tooltipItem.datasetIndex].dataType || '';
                            var label = tooltipItem.yLabel;
                            if (dataType == 'hashrate') label = getReadableHashRateString(tooltipItem.yLabel)+'/sec';
                            else label = formatNumber(tooltipItem.yLabel.toString(), ' ');
                            return ' ' + label;
                        }
                    }
                }
            }
        });
        $chart.closest('.poolChart').show();
    }
}
}

// Calculate current estimation
function calcEstimateProfit(){
    try {
        var rateUnit = Math.pow(1000,parseInt($('#calcHashUnit').data('mul')));
        var hashRate = parseFloat($('#calcHashRate').val()) * rateUnit;

        var profit = (hashRate * 86400 / lastStats.network.difficulty) * lastStats.pool.stats.lastblock_lastMinerReward;
        
        if (profit) {
            updateText('calcHashAmount1', getReadableCoins(profit));
            // updateText('calcHashAmount2', getCurrencyPriceText(profit));
            return;
        }
    } catch(e){ 
    	console.log(e);
    }
    updateText('calcHashAmount1', '');
    // updateText('calcHashAmount2', '');
}

// Get chart data
function getGraphData(rawData) {
    var graphData = {
        names: [],
        values: []
    };
    if(rawData) {
        for (var i = 0, xy; xy = rawData[i]; i++) {
            graphData.names.push(new Date(xy[0]*1000).toLocaleString());
            graphData.values.push(xy[1]);
        }
    }        
    return graphData;
}
</script>
